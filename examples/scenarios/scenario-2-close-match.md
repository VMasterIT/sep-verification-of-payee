# Сценарій 2: CLOSE_MATCH - Часткове співпадіння

## Контекст

**Учасники:**
- **Клієнт-платник:** Андрій Коваль (рахунок в Universal Bank)
- **Банк-відправник:** Universal Bank (Код ID НБУ: 300005)
- **Банк-отримувач:** Ощадбанк (Код ID НБУ: 300012)
- **Отримувач платежу:** Олена Петренко (рахунок в Ощадбанку)

**Тип операції:** Звичайний переказ на суму 5000 UAH

**Дата:** 2026-02-06, 10:15:00

**Проблема:** Клієнт ввів ім'я отримувача з помилкою (транслітерація або опечатка)

---

## Крок 1: Клієнт ініціює платіж з помилкою в імені

Андрій Коваль відкриває інтернет-банкінг Universal Bank та заповнює форму платежу:

```
Отримувач: PETRANKO OLENA IVANIVNA  ← Помилка: PETRANKO замість PETRENKO
IBAN: UA903052990000026001234567890
Сума: 5000 UAH
Призначення платежу: Повернення боргу
```

**Помилка:** Клієнт переплутав букви в прізвищі: **PETRANKO** замість правильного **PETRENKO**

**UI інтернет-банкінгу:**

```
┌────────────────────────────────┐
│      Новий платіж              │
├────────────────────────────────┤
│ Отримувач:                     │
│ [PETRANKO OLENA IVANIVNA    ] │ ← Помилка тут
│                                │
│ IBAN:                          │
│ [UA903052990000026001234567890]│
│                                │
│ Сума:                          │
│ [5000] UAH                     │
│                                │
│ Призначення:                   │
│ [Повернення боргу           ]  │
│                                │
│  [ Перевірити реквізити ]      │ ← Клієнт натискає
│                                │
└────────────────────────────────┘
```

---

## Крок 2: Frontend викликає VoP API

```http
POST https://api.universalbank.ua/payments/verify-payee
Authorization: Bearer {user_session_token}
Content-Type: application/json

{
  "recipientName": "PETRANKO OLENA IVANIVNA",
  "recipientIban": "UA903052990000026001234567890",
  "accountType": "PERSONAL",
  "paymentType": "REGULAR"
}
```

---

## Крок 3: Backend формує VoP Request

```json
{
  "requestId": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "timestamp": "2026-02-06T10:15:00.000Z",
  "requester": {
    "bic": "UNBUUA2XXXX",
    "nbuId": "300005"
  },
  "payee": {
    "iban": "UA903052990000026001234567890",
    "name": "PETRANKO OLENA IVANIVNA",
    "identificationType": "INN",
    "identificationCode": "2345678901"
  },
  "accountType": "PERSONAL",
  "paymentType": "REGULAR"
}
```

**Логування (Universal Bank):**

```
[2026-02-06T10:15:00.123Z] INFO: VoP Request initiated
  RequestID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
  IBAN: UA90********890
  Name: SHA256:def456...
  Type: REGULAR
```

---

## Крок 4: VoP Router направляє запит до Ощадбанку

```http
POST https://vop.oschadbank.ua/api/v1/verify
Authorization: Bearer {router_token}
Content-Type: application/json
X-Request-ID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d

{
  "requestId": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "timestamp": "2026-02-06T10:15:00.000Z",
  "requester": {
    "bic": "UNBUUA2XXXX",
    "nbuId": "300005"
  },
  "payee": {
    "iban": "UA903052990000026001234567890",
    "name": "PETRANKO OLENA IVANIVNA",
    "identificationType": "INN",
    "identificationCode": "2345678901"
  },
  "accountType": "PERSONAL",
  "paymentType": "REGULAR"
}
```

**Час відправки:** 10:15:00.200

---

## Крок 5: Ощадбанк обробляє запит

### 5.1 Пошук рахунку в БД

```sql
SELECT
  c.client_id,
  c.full_name,
  c.identification_type,
  c.identification_code,
  a.iban,
  a.account_status
FROM accounts a
JOIN clients c ON a.client_id = c.client_id
WHERE a.iban = 'UA903052990000026001234567890';
```

**Результат:**

```
client_id: 789012
full_name: ПЕТРЕНКО ОЛЕНА ІВАНІВНА  ← Правильне ім'я в БД
identification_type: INN
identification_code: 2345678901
iban: UA903052990000026001234567890
account_status: ACTIVE
```

**Час пошуку в БД:** 150 мс

### 5.2 Name Matching (тут виявляється розбіжність!)

```python
request_name = "PETRANKO OLENA IVANIVNA"  # З запиту (помилка)
db_name = "ПЕТРЕНКО ОЛЕНА ІВАНІВНА"      # З БД (правильно)

# Нормалізація
norm_request = normalize(request_name)
# → "petranko olena ivanivna" (латиниця)

norm_db = normalize(db_name)
# → "petrenko olena ivanivna" (транслітерація з кирилиці)

# Fuzzy matching
lev_score = levenshtein_similarity(norm_request, norm_db)
# "petranko" vs "petrenko" → 1 літера відрізняється
# Similarity: 87%

jw_score = jaro_winkler_similarity(norm_request, norm_db)
# Jaro-Winkler більш толерантний до префіксів
# Similarity: 92%

max_score = max(lev_score, jw_score)  # 92%

# Визначити статус
if max_score >= 95:
    match_status = "MATCH"
elif max_score >= 75:
    match_status = "CLOSE_MATCH"  ← Результат
    reason_code = "MBAM"
else:
    match_status = "NO_MATCH"
```

**Результат matching:**
- Match Status: `CLOSE_MATCH`
- Match Score: 92.0
- Reason Code: `MBAM` (Multiple Best Approximate Matches)

**Час matching:** 120 мс

### 5.3 Формування відповіді

```json
{
  "requestId": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "timestamp": "2026-02-06T10:15:01.050Z",
  "responder": {
    "bic": "OSCHCHUA2XXX",
    "nbuId": "300012"
  },
  "result": {
    "matchStatus": "CLOSE_MATCH",
    "matchScore": 92,
    "reasonCode": "MBAM",
    "reasonDescription": "Name close match - possible typo",
    "verifiedName": "ПЕТРЕНКО ОЛЕНА ІВАНІВНА",
    "accountStatus": "ACTIVE"
  },
  "processingTime": 850
}
```

**Логування (Ощадбанк):**

```
[2026-02-06T10:15:01.050Z] WARN: VoP CLOSE_MATCH detected
  RequestID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
  IBAN: UA90********890
  Request name: PETRANKO OLENA IVANIVNA
  DB name: ПЕТРЕНКО ОЛЕНА ІВАНІВНА
  Score: 92%
  Status: CLOSE_MATCH
```

**Час обробки:** 850 мс

---

## Крок 6: Router повертає відповідь до Universal Bank

```http
HTTP/1.1 200 OK
Content-Type: application/json
X-Request-ID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
X-Response-Time: 900

{
  "requestId": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "timestamp": "2026-02-06T10:15:01.100Z",
  "responder": {
    "bic": "OSCHCHUA2XXX",
    "nbuId": "300012"
  },
  "result": {
    "matchStatus": "CLOSE_MATCH",
    "matchScore": 92,
    "reasonCode": "MBAM",
    "reasonDescription": "Name close match - possible typo",
    "verifiedName": "ПЕТРЕНКО ОЛЕНА ІВАНІВНА",
    "accountStatus": "ACTIVE"
  },
  "processingTime": 900
}
```

**Загальний час обробки:** 900 мс (< 1 сек ✅)

---

## Крок 7: Universal Bank відображає попередження клієнту

Backend Universal Bank отримує CLOSE_MATCH та форматує для UI:

```json
{
  "status": "warning",
  "matchStatus": "CLOSE_MATCH",
  "matchScore": 92,
  "message": "⚠️ Можлива помилка в реквізитах",
  "details": "Ім'я отримувача не повністю співпадає",
  "enteredName": "PETRANKO OLENA IVANIVNA",
  "verifiedName": "ПЕТРЕНКО ОЛЕНА ІВАНІВНА",
  "accountStatus": "ACTIVE",
  "action": "REVIEW_REQUIRED"
}
```

**UI інтернет-банкінгу:**

```
┌────────────────────────────────────────────────────────┐
│  ⚠️  Можлива помилка в реквізитах                      │
├────────────────────────────────────────────────────────┤
│                                                        │
│ Ім'я отримувача не повністю співпадає з даними банку: │
│                                                        │
│ Ви ввели:                                              │
│ ┌────────────────────────────────────────────────┐    │
│ │ PETRANKO OLENA IVANIVNA                        │    │
│ └────────────────────────────────────────────────┘    │
│                                                        │
│ В банку зареєстровано:                                 │
│ ┌────────────────────────────────────────────────┐    │
│ │ ПЕТРЕНКО ОЛЕНА ІВАНІВНА                        │    │
│ └────────────────────────────────────────────────┘    │
│                                                        │
│ IBAN: UA903052990000026001234567890                    │
│ Статус рахунку: Активний                               │
│ Сума: 5000 UAH                                         │
│                                                        │
│ ┌────────────────────────────────────────────────┐    │
│ │ ℹ️  Рекомендація:                               │    │
│ │ Перевірте правильність написання імені.        │    │
│ │ Якщо це правильний отримувач, ви можете        │    │
│ │ продовжити платіж.                             │    │
│ └────────────────────────────────────────────────┘    │
│                                                        │
│     [ Виправити ім'я ]    [ Продовжити як є ]         │
│                                                        │
│     [ Скасувати платіж ]                               │
│                                                        │
└────────────────────────────────────────────────────────┘
```

**Час відображення:** 10:15:01.200 (1.2 сек з моменту натискання "Перевірити")

---

## Крок 8: Варіанти дій клієнта

### Варіант A: Клієнт виправляє ім'я ✅ (Рекомендовано)

Андрій Коваль помічає помилку та натискає **"Виправити ім'я"**:

```
┌────────────────────────────────┐
│      Виправлення реквізитів    │
├────────────────────────────────┤
│ Отримувач:                     │
│ [ПЕТРЕНКО ОЛЕНА ІВАНІВНА    ] │ ← Автоматично виправлено
│                                │
│ IBAN:                          │
│ [UA903052990000026001234567890]│
│                                │
│ Сума: 5000 UAH                 │
│                                │
│  [ Перевірити знову ]          │
│                                │
└────────────────────────────────┘
```

Клієнт натискає **"Перевірити знову"**:

**Новий VoP Request:**
```json
{
  "requestId": "b2c3d4e5-f6a7-4b8c-9d0e-1f2a3b4c5d6e",
  "timestamp": "2026-02-06T10:16:30.000Z",
  "payee": {
    "name": "ПЕТРЕНКО ОЛЕНА ІВАНІВНА"  ← Виправлено
  }
}
```

**VoP Response:**
```json
{
  "result": {
    "matchStatus": "MATCH",  ← Тепер MATCH!
    "matchScore": 100,
    "reasonCode": "ANNM"
  }
}
```

**UI:**
```
┌────────────────────────────────┐
│  ✅ Реквізити підтверджені     │
├────────────────────────────────┤
│ Отримувач:                     │
│ ПЕТРЕНКО ОЛЕНА ІВАНІВНА        │
│                                │
│ IBAN:                          │
│ UA903052990000026001234567890  │
│                                │
│ Сума: 5000 UAH                 │
│                                │
│     [ Підтвердити платіж ]     │
│     [ Скасувати ]              │
│                                │
└────────────────────────────────┘
```

Клієнт натискає **"Підтвердити платіж"** → платіж відправляється до СЕП.

**Результат:** ✅ Помилка виправлена, платіж виконано успішно.

---

### Варіант B: Клієнт продовжує з оригінальним ім'ям ⚠️

Андрій Коваль впевнений, що ім'я правильне (або знає, що отримувач має кілька варіантів написання), та натискає **"Продовжити як є"**:

```
┌────────────────────────────────────────────────────────┐
│  ⚠️  Підтвердження платежу з розбіжністю                │
├────────────────────────────────────────────────────────┤
│                                                        │
│ Ви підтверджуєте платіж з ім'ям, що не повністю       │
│ співпадає з даними банку-отримувача.                   │
│                                                        │
│ Ваше ім'я:                                             │
│ PETRANKO OLENA IVANIVNA                                │
│                                                        │
│ Зареєстроване ім'я:                                    │
│ ПЕТРЕНКО ОЛЕНА ІВАНІВНА                                │
│                                                        │
│ ⚠️  ВАЖЛИВО:                                           │
│ У випадку помилки повернення коштів може зайняти       │
│ до 72 годин.                                           │
│                                                        │
│     [ Я підтверджую і продовжую ]                      │
│                                                        │
│     [ Скасувати та виправити ]                         │
│                                                        │
└────────────────────────────────────────────────────────┘
```

Якщо клієнт натискає **"Я підтверджую і продовжую"**:

1. Universal Bank логує decision:
```
[2026-02-06T10:17:00.000Z] WARN: Client proceeded with CLOSE_MATCH
  RequestID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
  ClientID: 456789
  Decision: PROCEED_WITH_WARNING
  Original name: PETRANKO OLENA IVANIVNA
  Verified name: ПЕТРЕНКО ОЛЕНА ІВАНІВНА
```

2. Платіж відправляється до СЕП з **оригінальним** ім'ям (PETRANKO)

3. Ощадбанк отримує платіж та вирішує:
   - **Прийняти** (якщо їхня політика дозволяє CLOSE_MATCH)
   - **Відхилити** (якщо їхня політика вимагає exact match)

**Можливі результати:**

**Результат 1: Ощадбанк приймає платіж** ✅
- Платіж зараховується на рахунок Олени Петренко
- Все OK, незважаючи на розбіжність у написанні

**Результат 2: Ощадбанк відхиляє платіж** ❌
- pacs.002 з rejection code
- Universal Bank повертає кошти клієнту
- Клієнт має виправити реквізити та спробувати знову

---

### Варіант C: Клієнт скасовує платіж ❌

Андрій Коваль вирішує, що краще перевірити у отримувача правильне написання імені, та натискає **"Скасувати платіж"**:

```
┌────────────────────────────────┐
│  Платіж скасовано              │
├────────────────────────────────┤
│                                │
│ Платіж не було відправлено.    │
│                                │
│ Ви можете створити новий       │
│ платіж з правильними           │
│ реквізитами.                   │
│                                │
│     [ OK ]                     │
│                                │
└────────────────────────────────┘
```

**Результат:** ❌ Платіж скасовано, кошти залишились на рахунку клієнта.

---

## Статистика та метрики

### Часова діаграма

```
10:15:00.000  Клієнт натискає "Перевірити реквізити"
10:15:00.150  Universal Bank → VoP Router (VoP Request)
10:15:00.200  Router → Ощадбанк (VoP Request)
10:15:01.050  Ощадбанк → Router (VoP Response: CLOSE_MATCH) [850 мс]
10:15:01.100  Router → Universal Bank (VoP Response) [50 мс overhead]
10:15:01.200  CLOSE_MATCH warning відображається клієнту

--- Клієнт приймає рішення (20-60 сек) ---

Варіант A (виправлення):
10:16:30.000  Клієнт виправляє ім'я та перевіряє знову
10:16:31.000  MATCH результат → платіж підтверджується
10:16:35.000  pacs.008 відправлено до СЕП

Варіант B (продовження):
10:17:00.000  Клієнт підтверджує з попередженням
10:17:02.000  pacs.008 відправлено до СЕП (з оригінальним ім'ям)

Варіант C (скасування):
10:16:10.000  Клієнт скасовує платіж
               Кошти залишаються на рахунку
```

### Метрики VoP

| Метрика | Значення | Target | Status |
|---------|----------|--------|--------|
| VoP перевірка (end-to-end) | 1.2 сек | < 1.5 сек | ✅ |
| Ощадбанк processing | 850 мс | < 1 сек | ✅ |
| Matching score | 92% | 75-94% (CLOSE_MATCH) | ✅ |
| Client decision time | 20-60 сек | N/A | - |

### Бізнес-метрики

**Сценарій CLOSE_MATCH:**
- **Виявлено помилку:** ✅ Так (транслітерація/опечатка)
- **Клієнт виправив:** ✅ Варіант A (найкращий outcome)
- **Запобігли помилковому платежу:** ✅ Якщо клієнт виправив
- **Customer experience:** ⚠️ Warning, але корисний (запобіг помилці)

---

## Best Practices для банків

### 1. UI/UX для CLOSE_MATCH

**✅ DO:**
- Чітко показати **обидва** варіанти імені (введене vs зареєстроване)
- Надати **рекомендацію** (виправити ім'я)
- Дозволити **легке виправлення** (одна кнопка "Виправити")
- Показати **попередження** про можливі наслідки
- Логувати рішення клієнта для аудиту

**❌ DON'T:**
- НЕ показувати просто "помилка" без деталей
- НЕ блокувати платіж автоматично (клієнт має вирішувати)
- НЕ ховати verified name (клієнт має побачити)

### 2. Політика обробки CLOSE_MATCH

**Банк-відправник (Requester):**
- Завжди показувати warning клієнту
- Дозволити клієнту вибрати (виправити/продовжити/скасувати)
- Логувати всі CLOSE_MATCH cases для аналізу
- Metrics: % клієнтів які виправляють vs продовжують

**Банк-отримувач (Responder):**
- Визначити internal policy:
  - **Strict:** Приймати тільки MATCH (відхиляти CLOSE_MATCH)
  - **Lenient:** Приймати MATCH + CLOSE_MATCH
- Документувати policy в participation agreement
- Консистентна поведінка (не змінювати policy часто)

### 3. Matching Algorithm Tuning

**Thresholds:**
```
MATCH:        score >= 95%   ← High confidence
CLOSE_MATCH:  75% <= score < 95%  ← Medium confidence, review required
NO_MATCH:     score < 75%    ← Low confidence, reject
```

**Типові причини CLOSE_MATCH:**
- Транслітерація (ПЕТРЕНКО → PETRENKO → PETRANKO)
- Опечатки (ІВАНІВНА → IVANIVNA → IVANNIVNA)
- Порядок імен (ПЕТРЕНКО ОЛЕНА → ОЛЕНА ПЕТРЕНКО)
- Ініціали (ПЕТРЕНКО О.І. → ПЕТРЕНКО ОЛЕНА ІВАНІВНА)
- Подвійні прізвища (ПЕТРЕНКО-КОВАЛЬ → ПЕТРЕНКО)

**Fine-tuning:**
- Збирайте feedback від клієнтів
- Аналізуйте false positives/negatives
- Adjust thresholds якщо потрібно (але консервативно!)

### 4. Логування та аналітика

**Що логувати:**
```json
{
  "event": "vop_close_match",
  "request_id": "a1b2c3d4-...",
  "timestamp": "2026-02-06T10:15:01.200Z",
  "requester_nbu_id": "300005",
  "responder_nbu_id": "300012",
  "iban": "UA90********890",
  "entered_name_hash": "sha256:abc...",
  "verified_name_hash": "sha256:def...",
  "match_score": 92,
  "reason_code": "MBAM",
  "client_decision": "CORRECTED", // або "PROCEEDED" або "CANCELLED"
  "decision_time_seconds": 90
}
```

**Analytics dashboards:**
- % CLOSE_MATCH від total requests
- % клієнтів які виправляють vs продовжують
- Average match score для CLOSE_MATCH
- Найчастіші причини CLOSE_MATCH

---

## Висновки

**CLOSE_MATCH сценарій:**
- ✅ **Виявляє помилки** в реквізитах (транслітерація, опечатки)
- ✅ **Надає вибір** клієнту (виправити/продовжити/скасувати)
- ✅ **Запобігає помилковим платежам** (якщо клієнт виправляє)
- ⚠️ **Warning для клієнта** (не блокування, а інформування)

**Value proposition:**
- Баланс між **безпекою** (виявлення помилок) та **usability** (не блокування)
- Клієнт має **контроль** над рішенням
- Банки мають **гнучкість** у політиці (strict vs lenient)

**Результати (очікувані):**
- 70-80% клієнтів виправляють ім'я після CLOSE_MATCH warning
- 20-30% клієнтів продовжують з оригінальним ім'ям
- < 5% клієнтів скасовують платіж

---

**Версія:** 1.0
**Дата:** 2026-02-06
**Статус:** Draft
