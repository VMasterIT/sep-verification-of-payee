# Бізнес-правила для VoP СЕП НБУ

## Зміст

1. [Загальні правила](#загальні-правила)
2. [Правила обов'язковості VoP](#правила-обовязковості-vop)
3. [Правила Name Matching](#правила-name-matching)
4. [Правила обробки результатів](#правила-обробки-результатів)
5. [Правила для типів рахунків](#правила-для-типів-рахунків)
6. [Правила Opt-out](#правила-opt-out)
7. [Правила Timeout та Retry](#правила-timeout-та-retry)
8. [Правила логування](#правила-логування)
9. [Правила конфіденційності](#правила-конфіденційності)
10. [Правила SLA](#правила-sla)

---

## 1. Загальні правила

### BR-001: Застосування VoP

**Правило:** VoP перевірка виконується ПЕРЕД відправкою платіжного повідомлення pacs.008 до СЕП НБУ.

**Обґрунтування:** VoP не повинна уповільнювати обробку платежу в СЕП. Перевірка виконується на етапі підготовки платежу.

**Виключення:** Платежі всередині одного банку (on-us) не потребують VoP.

### BR-002: Версіонування API

**Правило:** Всі учасники використовують однакову версію VoP API.

**Поточна версія:** v1

**Deprecation policy:** Попередження про deprecated версію за 6 місяців, підтримка старої версії мінімум 12 місяців.

### BR-003: Уніка льність requestId

**Правило:** Кожен VoP запит має унікальний requestId (UUID v4).

**Ідемпотентність:** Повторний запит з тим же requestId повертає той же результат (якщо в межах 5 хвилин).

### BR-004: Timezone

**Правило:** Всі timestamp в UTC (ISO 8601 з 'Z' на кінці).

**Формат:** `2026-02-06T14:30:00Z` або `2026-02-06T14:30:00.123Z`

---

## 2. Правила обов'язковості VoP

### BR-010: Обов'язковість для миттєвих переказів

**Правило:** VoP перевірка ОБОВ'ЯЗКОВА для всіх миттєвих переказів (Instant Payments).

**Застосування:**
- ✅ Всі P2P (person-to-person) миттєві перекази
- ✅ Всі B2P (business-to-person) миттєві виплати зарплат, пенсій
- ✅ Всі P2B (person-to-business) миттєві платежі

**Виключення:**
- ❌ On-us перекази (всередині одного банку)
- ❌ Системні перекази (між банком та НБУ)

**Санкції за недотримання:** Відмова в обробці платежу + штраф (визначається НБУ).

### BR-011: Рекомендовано для звичайних переказів

**Правило:** VoP перевірка РЕКОМЕНДОВАНА для звичайних переказів (Regular Payments).

**Застосування:**
- ⚠️ Рекомендовано для P2P звичайних переказів
- ⚠️ Рекомендовано для B2P виплат (зарплати через пакетну обробку)

**Timeline:** Обов'язкова з Фази 3 (через 18 місяців після запуску).

### BR-012: Не застосовується

**Правило:** VoP НЕ застосовується для:

- On-us перекази (всередині банку)
- Міжбанківські перекази між рахунками банків у НБУ
- Системні операції (резервування, клірінг)
- Податкові платежі до бюджету (якщо НБУ не визначить інше)

---

## 3. Правила Name Matching

### BR-020: Threshold для MATCH

**Правило:** `matchStatus = MATCH` якщо similarity score ≥ 95%

**Методика розрахунку:** `max(levenshtein_similarity, jaro_winkler_similarity, token_based_similarity)`

**Приклад:**
```
Input: "ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ"
DB:    "ШЕВЧЕНКО ТАРАС ГРИГОРІЙОВИЧ"

Levenshtein: 92%
Jaro-Winkler: 96%
Token-based: 85%

Max: 96% → MATCH
```

### BR-021: Threshold для CLOSE_MATCH

**Правило:** `matchStatus = CLOSE_MATCH` якщо 75% ≤ similarity < 95%

**Обґрунтування:** Можлива помилка в написанні, ініціали, відсутнє по-батькові.

### BR-022: Threshold для NO_MATCH

**Правило:** `matchStatus = NO_MATCH` якщо similarity < 75%

**Обґрунтування:** Імена значно відрізняються, ймовірна помилка в реквізитах.

### BR-023: Нормалізація перед matching

**Правило:** Перед name matching обов'язкова нормалізація:

1. Lowercase (приведення до нижнього регістру)
2. Trim (видалення пробілів на початку/кінці)
3. Normalize spaces (множинні пробіли → одинарний)
4. Remove special characters (крім дефіса)
5. Remove dots after initials ("Т.Г." → "Т Г")

**Приклад:**
```
Input:  "  ШЕВЧЕНКО   Т.Г.  "
After:  "шевченко т г"
```

### BR-024: Обробка ініціалів

**Правило:** Якщо одне ім'я містить ініціали, а інше — повні імена:

**Варіант 1:** Видалити ініціали з обох імен та порівняти прізвища
```
"ШЕВЧЕНКО Т.Г." → "ШЕВЧЕНКО"
"ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ" → "ШЕВЧЕНКО"
→ MATCH (100%)
```

**Варіант 2:** Перевірити співпадіння ініціалів
```
"ШЕВЧЕНКО Т.Г." → ініціали: Т, Г
"ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ" → ініціали: Т, Г
→ MATCH (якщо прізвище співпадає + ініціали співпадають)
```

### BR-025: Case insensitive

**Правило:** Name matching не чутливий до регістру.

```
"шевченко тарас" = "ШЕВЧЕНКО ТАРАС" = "Шевченко Тарас"
→ MATCH
```

### BR-026: Транслітерація

**Правило:** Якщо одне ім'я кирилицею, а інше латиницею — виконати транслітерацію за ДСТУ 9112:2021 та порівняти.

**Приклад:**
```
Input: "SHEVCHENKO TARAS"
DB:    "ШЕВЧЕНКО ТАРАС"

Транслітерація: "ШЕВЧЕНКО ТАРАС" → "SHEVCHENKO TARAS"
→ MATCH
```

### BR-027: Порядок слів

**Правило:** Token-based matching для врахування різного порядку слів.

**Приклад:**
```
"ТАРАС ШЕВЧЕНКО" vs "ШЕВЧЕНКО ТАРАС"
→ Jaccard similarity: 100% (всі токени співпадають)
→ CLOSE_MATCH або MATCH (залежно від алгоритму)
```

---

## 4. Правила обробки результатів

### BR-030: Дія при MATCH

**Правило:** При `matchStatus = MATCH` клієнт може продовжити платіж без додаткових попереджень.

**UI:**
```
✅ Реквізити підтверджені
Отримувач: ШЕВЧЕНКО ТАРАС ГРИГОРІЙОВИЧ

[ Підтвердити платіж ]
```

**Логування:** Зберегти результат VoP з платежем.

### BR-031: Дія при CLOSE_MATCH

**Правило:** При `matchStatus = CLOSE_MATCH` показати попередження клієнту та запитати підтвердження.

**UI:**
```
⚠️ Увага! Можлива помилка в імені отримувача

Ви ввели: ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ
У банку-отримувачі: ШЕВЧЕНКО ТАРАС ГРИГОРІЙОВИЧ

Різниця: "ГРИГОРОВИЧ" vs "ГРИГОРІЙОВИЧ"

[ Виправити ]  [ Продовжити ]  [ Скасувати ]
```

**Вимога:** Клієнт має ЯВНО підтвердити продовження платежу.

**Логування:** Зберегти вибір клієнта (продовжив чи виправив).

### BR-032: Дія при NO_MATCH

**Правило:** При `matchStatus = NO_MATCH` рекомендується зупинити платіж.

**UI:**
```
❌ Ім'я не співпадає з рахунком отримувача

Ви ввели: ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ
IBAN: UA213223130000026007233566001

Можливі причини:
• Помилка в написанні імені
• Невірний IBAN
• Рахунок належить іншій особі

⚠️ Увага! Продовження може призвести до втрати коштів.

[ Виправити реквізити ]  [ Скасувати платіж ]

[ Продовжити на свій ризик ] (requires additional confirmation)
```

**Опційно:** Банк може дозволити продовження на ризик клієнта (з ЯВНИМ підтвердженням).

**Логування:** Обов'язково логувати, якщо клієнт продовжив при NO_MATCH.

### BR-033: Дія при NOT_SUPPORTED

**Правило:** При `matchStatus = NOT_SUPPORTED` інформувати клієнта, що перевірка недоступна.

**Причини:**
- `OPTO` — клієнт-отримувач відмовився від VoP
- `ACNS` — рахунок не підтримує VoP (корпоративний, спеціальний)

**UI:**
```
ℹ️ Перевірка реквізитів недоступна

Банк-отримувач не надає перевірку для цього рахунку.
Платіж буде оброблено як звичайно.

[ Продовжити ]  [ Скасувати ]
```

**Дія:** Дозволити продовження платежу (на ризик клієнта).

### BR-034: Дія при ERROR

**Правило:** При `matchStatus = ERROR` інформувати про технічну помилку.

**Причини:**
- `TCHA` — технічна помилка (timeout, database error)
- `UNKN` — невідома помилка

**UI:**
```
⚠️ Перевірка реквізитів недоступна

Технічна помилка. Спробуйте пізніше або продовжите без перевірки.

[ Спробувати ще раз ]  [ Продовжити без перевірки ]  [ Скасувати ]
```

**Retry:** Дозволити 1 спробу retry (автоматично або за бажанням клієнта).

**Fallback:** Дозволити продовження без VoP (на ризик клієнта).

---

## 5. Правила для типів рахунків

### BR-040: Особисті рахунки (PERSONAL)

**Правило:** Для `accountType = PERSONAL`:

- **identificationType:** `INN` або `PASSPORT`
- **Name format:** ПРІЗВИЩЕ ІМ'Я ПО-БАТЬКОВІ
- **Opt-out:** Дозволено

**Приклад:**
```json
{
  "accountType": "PERSONAL",
  "payee": {
    "name": "ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ",
    "identificationType": "INN",
    "identificationCode": "1234567890"
  }
}
```

### BR-041: Бізнес-рахунки (BUSINESS)

**Правило:** Для `accountType = BUSINESS`:

- **identificationType:** `EDRPOU` (обов'язково)
- **Name format:** [ТИП] НАЗВА КОМПАНІЇ
- **Opt-out:** Заборонено

**Приклад:**
```json
{
  "accountType": "BUSINESS",
  "payee": {
    "name": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ \"МОНОБАНК\"",
    "identificationType": "EDRPOU",
    "identificationCode": "14360570"
  }
}
```

### BR-042: Account Type Mismatch

**Правило:** Якщо `accountType` в запиті не співпадає з реальним типом рахунку:

- **PERSONAL → BUSINESS:** `reasonCode = BANM` (Business Account Name Match)
- **BUSINESS → PERSONAL:** `reasonCode = PAMM` (Personal Account May Match)

**Дія:** Показати попередження клієнту про невідповідність типу.

**UI:**
```
⚠️ Невідповідність типу рахунку

Ви вказали: Особистий рахунок
Рахунок отримувача: Бізнес-рахунок (ФОП ШЕВЧЕНКО ТАРАС)

[ Виправити ]  [ Продовжити ]  [ Скасувати ]
```

---

## 6. Правила Opt-out

### BR-050: Право на opt-out

**Правило:** Клієнти мають право відмовитися від VoP перевірки (opt-out).

**Обмеження:** Opt-out доступний ТІЛЬКИ для особистих рахунків (`accountType = PERSONAL`).

**Бізнес-рахунки:** Opt-out ЗАБОРОНЕНО для бізнес-рахунків з міркувань прозорості.

### BR-051: Процедура opt-out

**Правило:** Клієнт звертається до свого банку (отримувача) з заявою про opt-out.

**Процес:**
1. Клієнт подає заяву (письмову або через онлайн-банкінг)
2. Банк реєструє opt-out в БД (прапорець `vop_opted_out = TRUE`)
3. При VoP запиті банк повертає `matchStatus = NOT_SUPPORTED`, `reasonCode = OPTO`

**Застереження:** Банк має попередити клієнта про ризики (можливі помилкові платежі на користь клієнта).

### BR-052: Відкликання opt-out

**Правило:** Клієнт може відкликати opt-out в будь-який час.

**Процес:** Аналогічно opt-out (заява → банк видаляє прапорець).

### BR-053: Response при opt-out

**Правило:** Якщо клієнт opted out, банк-отримувач повертає:

```json
{
  "result": {
    "matchStatus": "NOT_SUPPORTED",
    "reasonCode": "OPTO",
    "reasonDescription": "Client opted out from VoP"
  }
}
```

**Не повертається:** `verifiedName`, `matchScore`, `accountStatus`

---

## 7. Правила Timeout та Retry

### BR-060: Timeout для VoP запиту

**Правило:** Максимальний час очікування відповіді на VoP запит: **3 секунди**.

**Обґрунтування:** Миттєві перекази мають загальний ліміт 10 сек. VoP не повинна займати більше 30% часу.

**Дія при timeout:**
- Router повертає `matchStatus = ERROR`, `reasonCode = TCHA`
- Банк-відправник дозволяє клієнту продовжити без VoP (на ризик клієнта)

### BR-061: Retry policy

**Правило:** При timeout або technical error дозволено **1 retry**.

**Delay між retry:** 500 мс

**Total timeout:** 3 сек (1-ша спроба) + 500 мс (delay) + 3 сек (2-га спроба) = 6.5 сек

**Після 2 невдалих спроб:** Повернути `ERROR` клієнту.

### BR-062: Circuit Breaker

**Правило:** Якщо банк-отримувач недоступний (5+ consecutive failures), активувати Circuit Breaker.

**Дія:**
- Наступні 5 хвилин: не надсилати запити до цього банку
- Повертати `ERROR` одразу (без виклику)
- Логувати incident для моніторингу

**Auto-recovery:** Через 5 хвилин спробувати 1 тестовий запит. Якщо успішний → відновити роботу.

---

## 8. Правила логування

### BR-070: Обов'язкове логування

**Правило:** Кожен VoP запит обов'язково логується всіма учасниками:

- **Requester:** Логує запит та відповідь
- **Router:** Логує запит, маршрутизацію, відповідь
- **Responder:** Логує запит та відповідь

**Формат лога:**
```json
{
  "timestamp": "2026-02-06T14:30:00.123Z",
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "requesterBic": "NBUBUBU1XXX",
  "responderBic": "PRYBUA2XXXX",
  "ibanMasked": "UA21********66001",
  "nameHash": "SHA256:abc123...",
  "matchStatus": "MATCH",
  "matchScore": 100,
  "processingTime": 850,
  "ipAddress": "10.0.1.5"
}
```

### BR-071: Маскування даних

**Правило:** В логах IBAN та ім'я мають бути замасковані або захешовані.

**IBAN masking:**
```
Original: UA213223130000026007233566001
Masked:   UA21********66001
```

**Name hashing:**
```
Original: ШЕВЧЕНКО ТАРАС ГРИГОРОВИЧ
Hash:     SHA256:5d41402abc4b2a76b9719d911017c592
```

**Обґрунтування:** GDPR, банківська таємниця.

### BR-072: Retention policy

**Правило:** Логи VoP зберігаються **90 днів**.

**Після 90 днів:**
- Варіант 1: Видалити логи
- Варіант 2: Анонімізувати (видалити IBAN, name hash)

**Виключення:** Логи з `matchStatus = NO_MATCH` та продовженим платежем зберігаються 1 рік (для аудиту шахрайства).

### BR-073: Audit trail

**Правило:** Вибір клієнта при `CLOSE_MATCH` та `NO_MATCH` обов'язково логується.

**Формат:**
```json
{
  "timestamp": "2026-02-06T14:30:05Z",
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "matchStatus": "NO_MATCH",
  "userAction": "CONTINUED",  // або "CANCELLED", "CORRECTED"
  "userId": "user-123",
  "ipAddress": "10.0.1.5"
}
```

---

## 9. Правила конфіденційності

### BR-080: Data minimization

**Правило:** Передавати тільки мінімально необхідні дані.

**Передається:**
- ✅ IBAN
- ✅ Ім'я/назва
- ✅ Ідентифікаційний код (ЄДРПОУ/ІПН)

**НЕ передається:**
- ❌ Номер телефону
- ❌ Email
- ❌ Адреса
- ❌ Дата народження
- ❌ Історія транзакцій
- ❌ Баланс рахунку

### BR-081: Згода клієнта

**Правило:** При відкритті рахунку клієнт інформується про VoP та дає згоду.

**Формулювання згоди:**
```
Я даю згоду на перевірку моїх реквізитів (IBAN та ім'я)
банками-відправниками через систему Verification of Payee (VoP)
для запобігання помилковим платежам.

Я розумію, що можу відмовитися від цієї послуги (opt-out)
в будь-який момент.

[ ] Погоджуюсь
```

### BR-082: Передача даних третім особам

**Правило:** Банк-отримувач НЕ має права передавати дані з VoP запитів третім особам.

**Виключення:**
- НБУ (для нагляду та аудиту)
- Правоохоронні органи (за судовим рішенням)

---

## 10. Правила SLA

### BR-090: Response time

**Правило:** Цільовий час відповіді:

| Сценарій | Target | Maximum |
|----------|--------|---------|
| Normal load | < 500 мс | 1000 мс |
| Peak load | < 1 сек | 3 сек |

**Вимірювання:** P99 latency (99-й перцентиль).

**Санкції:** Якщо P99 > 3 сек протягом 1 години → incident, ескалація до НБУ.

### BR-091: Uptime

**Правило:** Мінімальна доступність: **99.9%**

**Дозволений downtime:** 8.76 годин на рік (43.2 хвилини на місяць).

**Planned maintenance:** Дозволено до 4 годин на місяць (повідомлення за 48 годин).

**Вимірювання:** Health check кожні 10 секунд.

### BR-092: Throughput

**Правило:** Router має підтримувати мінімум **1000 req/sec**.

**Scalability:** Horizontal scaling для обробки пікових навантажень.

**Peak hours:** 9:00-11:00, 17:00-19:00 (очікуване навантаження до 2000 req/sec).

### BR-093: Error rate

**Правило:** Максимальна частота помилок: **< 1%**

**Вимірювання:**
```
Error Rate = (кількість ERROR responses) / (загальна кількість запитів) * 100%
```

**Виключення:** `NOT_SUPPORTED` (OPTO, ACNS) не вважаються помилками.

**Санкції:** Якщо error rate > 5% протягом 1 години → incident.

### BR-094: Incident Management

**Правило:** При критичному incident (error rate > 10%, downtime > 15 хв):

1. **Негайно:** Повідомити НБУ та всіх учасників
2. **Fallback:** Дозволити платежі без VoP (на ризик клієнтів)
3. **RCA:** Root Cause Analysis протягом 24 годин
4. **Resolution:** Відновити роботу протягом 4 годин

---

## Матриця бізнес-правил

### Швидкий довідник

| Правило | Категорія | Пріоритет | Санкції |
|---------|-----------|-----------|---------|
| BR-010 | Обов'язковість для IP | Критичний | Відмова + штраф |
| BR-020-027 | Name Matching | Високий | - |
| BR-030-034 | Обробка результатів | Високий | - |
| BR-040-042 | Типи рахунків | Середній | - |
| BR-050-053 | Opt-out | Середній | - |
| BR-060-062 | Timeout/Retry | Високий | - |
| BR-070-073 | Логування | Високий | Штраф при порушенні |
| BR-080-082 | Конфіденційність | Критичний | GDPR штрафи |
| BR-090-094 | SLA | Критичний | Penalties |

---

## Висновки

Бізнес-правила VoP забезпечують:

✅ **Обов'язковість для IP** — зменшення помилкових платежів
✅ **Чіткі threshold** — 95%, 75% для різних статусів
✅ **Opt-out для приватності** — тільки для особистих рахунків
✅ **Timeout та retry** — захист від уповільнення
✅ **GDPR compliance** — маскування, 90-денна retention
✅ **Strict SLA** — 99.9% uptime, < 1 сек latency

---

**Версія:** 1.0
**Дата:** 2026-02-06
**Статус:** Draft
